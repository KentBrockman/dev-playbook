---
- name: install terminal related packages
  become: true
  apt:
    pkg:
      # better shell and helper methods
      - zsh
      - zsh-autosuggestions
      # terminal multiplexer
      - tmux
      # cli text editor
      - vim
      # use clipboard from terminal
      - xclip
      # great fuzzy finder utility
      - fzf
      # nice grep replacement
      - ripgrep
      # cat/less upgrade with syntax highlighting
      - bat
      # JSON formatter
      - jq

- name: check if dotfiles are installed
  stat:
    path: ~/dotfiles
  register: dotfiles

- name: install dotfiles
  block:
    - name: checkout dotfiles
      git:
        repo: https://github.com/kentbrockman/dotfiles
        dest: ~/dotfiles

    - name: install dotfiles
      command: ~/dotfiles/install.sh

    - name: Set gitconfig user header
      lineinfile:
        path: ~/.gitconfig
        line: "[user]"
        state: present

    - name: Set gitconfig user name and email
      lineinfile:
        path: ~/.gitconfig
        insertafter: '\[user\]'
        line: "{{ item.line }}"
        regexp: "{{ item.regexp }}"
        state: present
      loop:
        - regexp: 'name\ =.*'
          line: "name = {{ your_full_name }}"
        - regexp: 'email\ =.*'
          line: "email = {{ your_email }}"
  when: not dotfiles.stat.exists and install_dotfiles

- name: Install oh-my-zsh
  git:
    repo: https://github.com/robbyrussell/oh-my-zsh.git
    dest: ~/.oh-my-zsh

- name: confirm preferred shell executable is installed
  stat:
    path: "{{ preferred_shell }}"
  register: preferred_shell_executable

- name: set preferred shell for user
  become: true
  user:
    name: "{{ ansible_user_id }}"
    shell: "{{ preferred_shell }}"
  when: preferred_shell_executable.stat.exists

- name: ensure local font directory exists
  file:
    name: ~/.local/share/fonts
    state: directory

- name: install custom fonts
  block:
    - name: get all custom fonts
      command: "ls {{ font_src_dir }}"
      register: fonts
      changed_when: False

    - name: install custom fonts
      copy:
        src: "{{ font_src_dir }}/{{ item }}"
        dest: "~/.local/share/fonts/{{ item }}"
      with_items: "{{ fonts.stdout_lines }}"
  vars:
    font_src_dir: "files/fonts"
  tags: ['fonts']
