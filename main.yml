---
- hosts:
  - dev_boxes
  - test_boxes
  - localhost

  vars:
    # determine where the playbook is on the target machine
    # when local: use playbook_dir, which is a built in var for where playbook is on the host
    # when on ssh: dev_playbook_checkout_dir is supplied by host or group vars to check it out
    dev_playbook_directory: "{{ playbook_dir if ansible_connection == 'local' else dev_playbook_checkout_dir }}"

  pre_tasks:
    - name: update packages
      become: true
      apt:
        update_cache: yes
      changed_when: False

    - name: install python dependencies for playbook
      pip:
        name:
          # TODO: re-verify these requirements
          # all of these dependencies are needed for ansible to run properly. experimentally discovered...
          - requests
          - psutil

  tasks:
    - name: set hostname
      tags: ["hostname"]
      hostname:
        name: "{{ hostname }}"
        use: systemd
      when: set_hostname

    # make it easy to run this playbook
    - name: ensure various directories exist
      file:
        dest: "{{ item }}"
        state: directory
      with_items:
        - ~/.local/bin
        - ~/code

    - name: make sure this repo exists on dev box
      git:
        repo: https://github.com/kentbrockman/dev-playbook.git
        dest: ~/code/dev-playbook/
        update: no

    - name: add run-dev-playbook to local scripts
      tags: ["run-dev-playbook"]
      template:
        src: files/run-dev-playbook.sh
        dest: ~/.local/bin/run-dev-playbook.sh
        mode: 0544

    # set up terminal experience
    - import_tasks: tasks/dotfiles.yml
      tags: ["dotfiles"]
      when: install_dotfiles
    - import_tasks: tasks/terminal.yml
      tags: ["terminal"]
    - import_tasks: tasks/tmux-plugins.yml
      tags: ["tmux-plugins"]
    - import_tasks: tasks/vim-plugins.yml
      tags: ["vim-plugins"]
    - import_tasks: tasks/remote-access.yml
      tags: ["remote-access"]

    # set up GUI experience
    - import_tasks: tasks/web-browser.yml
      tags: ["web-browser"]
    - import_tasks: tasks/applications.yml
      tags: ["applications"]
    - import_tasks: tasks/gnome-desktop.yml
      tags: ["gnome-desktop"]

    # development tools
    - import_tasks: tasks/python-dev.yml
      tags: ["python-dev"]
    - import_tasks: tasks/javascript-dev.yml
      tags: ["javascript-dev"]
    - import_tasks: tasks/golang-dev.yml
      tags: ["golang-dev"]
    - import_tasks: tasks/ops-dev.yml
      tags: ["ops-dev"]

    # text editors
    - import_tasks: tasks/vscode.yml
      tags: ["vscode"]
    - import_tasks: tasks/neovim.yml
      tags: ["neovim"]

    # other things
    - import_tasks: tasks/sync-content.yml
      tags: ["sync-content"]
      when: sync_content
    - import_tasks: tasks/battery-management.yml
      tags: ["battery-management"]
      when: install_battery_management_tools
